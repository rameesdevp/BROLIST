<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brolist - Project Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .sidebar-bg {
            background-color: #f8fafc;
        }
        
        .topbar-bg {
            background-color: #ffffff;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .main-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }
        
        .task-card {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
        }
        
        .mountain-shape {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 200px;
            overflow: hidden;
        }
        
        .mountain-1 {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 0;
            border-left: 300px solid transparent;
            border-right: 300px solid transparent;
            border-bottom: 150px solid #dc2626;
            opacity: 0.8;
        }
        
        .mountain-2 {
            position: absolute;
            bottom: 0;
            right: 200px;
            width: 0;
            height: 0;
            border-left: 250px solid transparent;
            border-right: 250px solid transparent;
            border-bottom: 120px solid #7c3aed;
            opacity: 0.7;
        }
        
        .mountain-3 {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 0;
            height: 0;
            border-left: 200px solid transparent;
            border-right: 200px solid transparent;
            border-bottom: 100px solid #dc2626;
            opacity: 0.6;
        }
        
        .profile-avatar {
            background-color: #3b82f6;
            width: 80px;
            height: 80px;
        }
        
        .profile-avatar-small {
            background-color: #3b82f6;
            width: 40px;
            height: 40px;
        }
        
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #dc2626;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .hover-scale {
            transition: transform 0.2s ease;
        }
        
        .hover-scale:hover {
            transform: scale(1.05);
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.05);
                opacity: 0.8;
            }
        }
        
        .sidebar-collapsed {
            width: 80px !important;
        }
        
        .sidebar-collapsed .nav-text,
        .sidebar-collapsed .profile-info,
        .sidebar-collapsed .quote-box {
            display: none !important;
        }
        
        .sidebar-collapsed .profile-avatar {
            width: 50px !important;
            height: 50px !important;
            font-size: 18px !important;
        }
        
        .sidebar-collapsed .nav-btn {
            justify-content: center !important;
            padding: 12px !important;
        }
        
        .sidebar-collapsed .nav-btn svg {
            margin: 0 !important;
            width: 24px !important;
            height: 24px !important;
        }
        
        /* Night Mode Styles */
        .dark {
            color-scheme: dark;
        }
        
        .dark body {
            background-color: #1a1a1a;
            color: #e5e5e5;
        }
        
        .dark .sidebar-bg {
            background-color: #2d2d2d;
            border-right: 1px solid #404040;
        }
        
        .dark .topbar-bg {
            background-color: #2d2d2d;
            border-bottom: 1px solid #404040;
        }
        
        .dark .main-gradient {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 50%, #1a202c 100%);
        }
        
        .dark .login-gradient {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 50%, #1a202c 100%);
        }
        
        .dark .task-card,
        .dark .bg-white {
            background-color: #374151 !important;
            border-color: #4b5563 !important;
            color: #e5e5e5 !important;
        }
        
        .dark .text-gray-800 {
            color: #e5e5e5 !important;
        }
        
        .dark .text-gray-700 {
            color: #d1d5db !important;
        }
        
        .dark .text-gray-600 {
            color: #9ca3af !important;
        }
        
        .dark .text-gray-500 {
            color: #6b7280 !important;
        }
        
        .dark .border-gray-200,
        .dark .border-gray-300 {
            border-color: #4b5563 !important;
        }
        
        .dark .bg-gray-50 {
            background-color: #374151 !important;
        }
        
        .dark .bg-gray-100 {
            background-color: #4b5563 !important;
        }
        
        .dark .hover\:bg-gray-200:hover {
            background-color: #4b5563 !important;
        }
        
        .dark .hover\:bg-gray-100:hover {
            background-color: #374151 !important;
        }
        
        .dark input,
        .dark textarea,
        .dark select {
            background-color: #374151 !important;
            border-color: #4b5563 !important;
            color: #e5e5e5 !important;
        }
        
        .dark input:focus,
        .dark textarea:focus,
        .dark select:focus {
            background-color: #4b5563 !important;
            border-color: #6366f1 !important;
        }
        
        .dark .bg-gray-300 {
            background-color: #4b5563 !important;
        }
        
        .dark .text-gray-700 {
            color: #d1d5db !important;
        }
        
        .dark .hover\:bg-gray-400:hover {
            background-color: #374151 !important;
        }
        
        .dark .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: #4b5563 !important;
        }
        
        .dark .border-gray-100 {
            border-color: #4b5563 !important;
        }
        
        .dark .bg-black {
            background-color: #000000 !important;
        }
        
        .dark .shadow-lg,
        .dark .shadow-sm {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2) !important;
        }
        
        /* Night mode toggle button */
        .night-mode-btn {
            transition: transform 0.3s ease;
        }
        
        .night-mode-btn:hover {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4 login-gradient">
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in border border-white/20">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-2">brolist</h1>
                <p class="text-gray-600">Sign in to manage your projects</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="loginEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-300 bg-gray-50 focus:bg-white" placeholder="Enter your email" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-300 bg-gray-50 focus:bg-white" placeholder="Enter your password" required>
                </div>
                
                <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all duration-300 font-medium shadow-lg hover:shadow-xl transform hover:scale-[1.02]">
                    Sign In
                </button>
            </form>
            
            <div class="mt-6 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border border-purple-100">
                <p class="text-sm text-purple-700 font-medium mb-2">Demo Accounts:</p>
                <p class="text-xs text-purple-600">Admin: admin@company.com / admin123</p>
                <p class="text-xs text-purple-600">Staff: john@company.com / staff123</p>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Top Bar -->
        <header class="topbar-bg shadow-sm h-16 flex items-center justify-between px-6 relative z-10">
            <!-- Logo and Toggle -->
            <div class="flex items-center space-x-4">
                <button id="sidebarToggle" class="p-2 rounded-lg hover:bg-gray-200 transition-colors">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <h1 class="text-2xl font-bold text-gray-800">brolist</h1>
            </div>
            
            <!-- Center Project Tag -->
            <div class="absolute left-1/2 transform -translate-x-1/2">
                <span class="bg-blue-100 text-blue-800 px-4 py-2 rounded-full text-sm font-medium">
                    Broto Business Consultants
                </span>
            </div>
            
            <!-- Right Icons -->
            <div class="flex items-center space-x-4">
                <!-- Night Mode -->
                <button id="nightModeToggle" class="p-2 rounded-lg hover:bg-gray-200 transition-colors night-mode-btn">
                    <svg id="nightModeIcon" class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>
                
                <!-- Refresh -->
                <button onclick="refreshPage()" class="p-2 rounded-lg hover:bg-gray-200 transition-colors">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
                
                <!-- Notifications with Badge -->
                <div class="relative group">
                    <button class="p-2 rounded-lg hover:bg-gray-200 transition-colors relative">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364-.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                        <span class="notification-badge">0</span>
                    </button>
                    
                    <!-- Notifications Dropdown -->
                    <div class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-lg border border-gray-200 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-[9999] max-h-96 overflow-y-auto">
                        <div class="p-3 border-b border-gray-100">
                            <h3 class="font-medium text-gray-800">Notifications</h3>
                        </div>
                        <div id="notificationsList" class="p-2">
                            <!-- Notifications will be populated here -->
                        </div>
                    </div>
                </div>

                
                <!-- Profile Dropdown -->
                <div class="relative group">
                    <button class="profile-avatar-small rounded-full flex items-center justify-center text-white font-semibold hover:opacity-90 transition-opacity" id="headerProfileBtn">
                        <span id="headerInitials">RK</span>
                    </button>
                    
                    <!-- Profile Dropdown Menu -->
                    <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-[99999]">
                        <div class="p-3 border-b border-gray-100">
                            <div class="font-medium text-gray-800" id="dropdownUserName"></div>
                            <div class="text-sm text-gray-500" id="dropdownUserRole"></div>
                        </div>
                        <div class="p-2">
                            <button onclick="goToProfile()" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                                ⚙️ Profile Settings
                            </button>
                            <button id="logoutBtn" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                                🚪 Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="flex h-screen">
            <!-- Left Sidebar -->
            <aside id="sidebar" class="sidebar-bg w-80 shadow-lg flex flex-col transition-all duration-300 ease-in-out">
                <!-- Profile Section -->
                <div class="p-8 text-center">
                    <div class="profile-avatar rounded-full mx-auto flex items-center justify-center text-white text-2xl font-bold mb-4" id="sidebarAvatar">
                        <span id="sidebarInitials">RK</span>
                    </div>
                    <div class="profile-info">
                        <h3 class="text-lg font-semibold text-gray-800 mb-1" id="sidebarUserName">Ramees Shuhsad K</h3>
                        <p class="text-gray-600 text-sm" id="sidebarUserRole">Trainee</p>
                    </div>
                </div>
                
                <!-- Navigation -->
                <nav class="px-6 flex-1">
                    <div class="space-y-2">
                        <!-- Dashboard Button -->
                        <button class="nav-btn w-full flex items-center space-x-3 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors" data-section="dashboard">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v6H8V5z"></path>
                            </svg>
                            <span class="nav-text font-medium">Dashboard</span>
                        </button>
                        
                        <!-- Tasks Button -->
                        <button class="nav-btn w-full flex items-center space-x-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors" data-section="tasks">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            <span class="nav-text font-medium">Tasks</span>
                        </button>
                        
                        <!-- Projects Button -->
                        <button class="nav-btn w-full flex items-center space-x-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors" data-section="projects">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v6H8V5z"></path>
                            </svg>
                            <span class="nav-text font-medium">Projects</span>
                        </button>
                        
                        <!-- Chat Button -->
                        <button class="nav-btn w-full flex items-center space-x-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors" data-section="chat">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"></path>
                            </svg>
                            <span class="nav-text font-medium">Chat</span>
                        </button>
                        
                        <!-- Admin Navigation -->
                        <button id="adminNav" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors hidden" data-section="admin">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                            <span class="nav-text font-medium">Manage Users</span>
                        </button>
                        
                        <!-- Profile Button -->
                        <button class="nav-btn w-full flex items-center space-x-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors" data-section="profile">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <span class="nav-text font-medium">Profile</span>
                        </button>
                    </div>
                </nav>
                
                <!-- Quote Box -->
                <div class="p-6 quote-box">
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <p class="text-sm text-gray-700 italic leading-relaxed">
                            "The best way to predict the future is to create it."
                        </p>
                        <p class="text-xs text-gray-500 mt-2 text-right">– Peter Drucker</p>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 overflow-hidden">
                <!-- Dashboard Section -->
                <div id="dashboardSection" class="section main-gradient relative overflow-hidden h-full">
                    <!-- Mountain Shapes -->
                    <div class="mountain-shape">
                        <div class="mountain-1"></div>
                        <div class="mountain-2"></div>
                        <div class="mountain-3"></div>
                    </div>
                    
                    <!-- Content -->
                    <div class="relative z-10 p-8 h-full overflow-y-auto">
                        <!-- Header -->
                        <div class="flex items-center justify-between mb-8">
                            <h1 class="text-4xl font-bold text-white">Main Dashboard</h1>
                            <button onclick="showTodaysTasks()" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition-colors shadow-sm">
                                Today's Tasks
                            </button>
                        </div>
                        
                        <!-- Task Cards Grid -->
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 fade-in" id="dashboardTaskCards">
                            <!-- Task cards will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Tasks Section -->
                <div id="tasksSection" class="section hidden p-6 h-full overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Tasks</h2>
                        <div class="flex space-x-3">
                            <button id="clearFilterBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors hidden" onclick="clearTaskFilter()">
                                Show All Tasks
                            </button>
                            <button id="addTaskBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors hidden">
                                + Add Task
                            </button>
                        </div>
                    </div>

                    <div class="grid gap-4">
                        <div id="tasksList" class="space-y-4">
                            <!-- Tasks will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Projects Section -->
                <div id="projectsSection" class="section hidden p-6 h-full overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Projects</h2>
                        <button id="addProjectBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors hidden">
                            + Add Project
                        </button>
                    </div>

                    <div class="space-y-6" id="projectsList">
                        <!-- Projects will be populated here -->
                    </div>
                </div>

                <!-- Admin Section -->
                <div id="adminSection" class="section hidden p-6 h-full overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">User Management</h2>
                        <button id="addUserBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            + Add User
                        </button>
                    </div>

                    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contact</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersList" class="divide-y divide-gray-200">
                                <!-- Users will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Chat Section -->
                <div id="chatSection" class="section hidden h-full flex flex-col">
                    <div class="flex h-full">
                        <!-- Chat Users List -->
                        <div class="w-1/3 bg-white border-r border-gray-200 flex flex-col">
                            <div class="p-4 border-b border-gray-200">
                                <h2 class="text-xl font-bold text-gray-800">Messages</h2>
                                <div class="mt-3">
                                    <input type="text" id="chatSearch" placeholder="Search users..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div class="flex-1 overflow-y-auto" id="chatUsersList">
                                <!-- Chat users will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Chat Messages Area -->
                        <div class="flex-1 flex flex-col">
                            <!-- Chat Header -->
                            <div id="chatHeader" class="p-4 border-b border-gray-200 bg-white hidden">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold" id="chatUserAvatar">
                                        <span id="chatUserInitials">U</span>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-gray-800" id="chatUserName">Select a user</h3>
                                        <p class="text-sm text-gray-500" id="chatUserRole">Role</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Messages Container -->
                            <div class="flex-1 overflow-y-auto p-4 bg-gray-50" id="chatMessages">
                                <div class="flex items-center justify-center h-full text-gray-500">
                                    <div class="text-center">
                                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"></path>
                                        </svg>
                                        <p class="text-lg font-medium">Select a conversation</p>
                                        <p class="text-sm">Choose a user from the list to start chatting</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Message Input -->
                            <div class="p-4 bg-white border-t border-gray-200 hidden" id="chatInput">
                                <div class="flex space-x-3">
                                    <input type="text" id="messageInput" placeholder="Type your message..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onkeypress="handleMessageKeyPress(event)">
                                    <button onclick="sendMessage()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div id="profileSection" class="section hidden p-6 h-full overflow-y-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Profile Settings</h2>
                    <div class="bg-white rounded-lg shadow-sm p-6 max-w-2xl">
                        <div class="flex items-start space-x-6 mb-6">
                            <div class="flex-shrink-0">
                                <div class="profile-avatar rounded-full flex items-center justify-center text-white text-2xl font-bold" id="profileAvatar">
                                    <span id="profileInitials">RK</span>
                                </div>
                                <button id="changeProfilePicBtn" class="mt-2 text-sm text-orange-600 hover:text-orange-800">Change Photo</button>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-800 mb-2" id="profileDisplayName"></h3>
                                <p class="text-gray-600" id="profileDisplayRole"></p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                                <input type="text" id="profileName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                                <input type="email" id="profileEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                <input type="tel" id="profilePhone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Profile Picture</label>
                                <input type="file" id="profilePictureFile" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-gray-500 mt-1">Choose an image file (JPG, PNG, GIF)</p>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                                <textarea id="profileAddress" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex space-x-3">
                            <button id="updateProfileBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                Update Profile
                            </button>
                            <button id="cancelProfileBtn" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                                Cancel Changes
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="taskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md fade-in">
            <h3 class="text-lg font-bold mb-4">Add New Task</h3>
            <form id="taskForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                    <input type="text" id="taskTitle" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="taskDescription" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Project</label>
                    <select id="taskProject" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <!-- Projects will be populated here -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Assign to</label>
                    <select id="taskAssignee" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <!-- Users will be populated here -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                    <select id="taskPriority" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                    <input type="date" id="taskDueDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Create Task
                    </button>
                    <button type="button" id="cancelTaskBtn" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div id="projectModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md fade-in">
            <h3 class="text-lg font-bold mb-4">Add New Project</h3>
            <form id="projectForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Project Name</label>
                    <input type="text" id="projectName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="projectDescription" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                    <input type="date" id="projectStartDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                    <input type="date" id="projectEndDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Create Project
                    </button>
                    <button type="button" id="cancelProjectBtn" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Task Details Modal -->
    <div id="taskDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl fade-in max-h-screen overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold">Task Details</h3>
                <button onclick="closeTaskDetailsModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="taskDetailsContent">
                <!-- Task details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="userModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg fade-in max-h-screen overflow-y-auto">
            <h3 id="userModalTitle" class="text-lg font-bold mb-4">Add New User</h3>
            <form id="userForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                        <input type="text" id="userName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="userEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="userPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                        <input type="tel" id="userPhone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="+1 (555) 123-4567">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                        <select id="userRole" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="toggleCustomRole()">
                            <option value="staff">Staff</option>
                            <option value="admin">Admin</option>
                            <option value="trainee">Trainee</option>
                            <option value="manager">Manager</option>
                            <option value="custom">Custom Role</option>
                        </select>
                        <input type="text" id="customRoleInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mt-2 hidden" placeholder="Enter custom role name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Profile Picture</label>
                        <input type="file" id="userProfilePicture" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Choose an image file (JPG, PNG, GIF)</p>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                    <textarea id="userAddress" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Street address, city, state, zip code"></textarea>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" id="userSubmitBtn" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors">
                        Create User
                    </button>
                    <button type="button" id="cancelUserBtn" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data Storage with Persistence
        let currentUser = null;
        let sidebarCollapsed = false;
        let notifications = JSON.parse(localStorage.getItem('brolist_notifications')) || [];
        let isDarkMode = JSON.parse(localStorage.getItem('brolist_darkMode')) || false;
        let editingUserId = null;
        let messages = JSON.parse(localStorage.getItem('brolist_messages')) || [];
        let selectedChatUser = null;
        
        // Quotes Collection
        const quotes = [
            {
                text: "In the world of business, the rearview mirror is always clearer than the windshield.",
                author: "Warren Buffett"
            },
            {
                text: "An accountant is someone who solves a problem you didn't know you had in a way you don't understand.",
                author: "Anonymous"
            },
            {
                text: "Behind every good business is a great accountant.",
                author: "Anonymous"
            },
            {
                text: "The hardest thing in the world to understand is the income tax.",
                author: "Albert Einstein"
            },
            {
                text: "Accounting is the language of business.",
                author: "Warren Buffett"
            },
            {
                text: "A good accountant is a blessing, a bad accountant is a curse.",
                author: "Anonymous"
            },
            {
                text: "Numbers may not lie, but they can sure mislead.",
                author: "Anonymous"
            },
            {
                text: "Creativity is great, but not in accounting.",
                author: "Charles Scott"
            },
            {
                text: "Accounting does not make corporate earnings or balance sheets more volatile. Accounting just increases the transparency of volatility in earnings.",
                author: "Diane Garnick"
            },
            {
                text: "Good accounting is the soul of business.",
                author: "Anonymous"
            },
            {
                text: "Life is like accounting; everything must be balanced.",
                author: "Anonymous"
            },
            {
                text: "Accounting is the art of managing chaos with logic and numbers, much like life itself.",
                author: "Anonymous"
            },
            {
                text: "In both life and accounting, precision and honesty pave the way to success.",
                author: "Anonymous"
            },
            {
                text: "Just as in accounting, in life, every choice we make has consequences.",
                author: "Anonymous"
            },
            {
                text: "Good judgment comes from experience, just like good accounting comes from careful analysis.",
                author: "Anonymous"
            },
            {
                text: "Life is a continuous audit, and integrity is the key to passing it.",
                author: "Anonymous"
            },
            {
                text: "In accounting and in life, the details matter just as much as the big picture.",
                author: "Anonymous"
            },
            {
                text: "Life's challenges are like complex calculations; they require patience and problem-solving skills.",
                author: "Anonymous"
            },
            {
                text: "Much like in accounting, the best results in life come from planning and discipline.",
                author: "Anonymous"
            },
            {
                text: "Accountability is not just an accounting principle; it's a way of living.",
                author: "Anonymous"
            },
            {
                text: "Success is no accident. It is hard work, perseverance, learning, studying, sacrifice, and most of all, love of what you are doing.",
                author: "Pelé"
            },
            {
                text: "The difference between ordinary and extraordinary is that little extra.",
                author: "Jimmy Johnson"
            },
            {
                text: "The expert in anything was once a beginner.",
                author: "Helen Hayes"
            },
            {
                text: "Your limitation—it's only your imagination.",
                author: "Anonymous"
            },
            {
                text: "Don't watch the clock; do what it does. Keep going.",
                author: "Sam Levenson"
            },
            {
                text: "Dreams don't work unless you do.",
                author: "John C. Maxwell"
            },
            {
                text: "The road to success and the road to failure are almost exactly the same.",
                author: "Colin R. Davis"
            },
            {
                text: "The best way to predict the future is to create it.",
                author: "Peter Drucker"
            }
        ];
        
        // Default data
        const defaultUsers = [
            { 
                id: 1, 
                name: 'Admin User', 
                email: 'admin@company.com', 
                password: 'admin123', 
                role: 'admin',
                phone: '+1 (555) 123-4567',
                address: '123 Business Ave, Suite 100, New York, NY 10001',
                profilePicture: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face'
            },
            { 
                id: 2, 
                name: 'Ramees Shuhsad K', 
                email: 'ramees@company.com', 
                password: 'trainee123', 
                role: 'trainee',
                phone: '+1 (555) 234-5678',
                address: '456 Oak Street, Apartment 2B, Brooklyn, NY 11201',
                profilePicture: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150&h=150&fit=crop&crop=face'
            },
            { 
                id: 3, 
                name: 'John Smith', 
                email: 'john@company.com', 
                password: 'staff123', 
                role: 'staff',
                phone: '+1 (555) 345-6789',
                address: '789 Pine Road, Unit 5C, Queens, NY 11375',
                profilePicture: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=150&h=150&fit=crop&crop=face'
            },
            { 
                id: 4, 
                name: 'Sarah Johnson', 
                email: 'sarah@company.com', 
                password: 'staff123', 
                role: 'manager',
                phone: '+1 (555) 456-7890',
                address: '321 Elm Street, Suite 4A, Manhattan, NY 10002',
                profilePicture: 'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=150&h=150&fit=crop&crop=face'
            }
        ];
        
        const defaultProjects = [
            { id: 1, name: 'E-Commerce Platform', description: 'Complete e-commerce solution with payment integration', status: 'active', createdBy: 1, startDate: '2024-01-01', endDate: '2024-06-30' },
            { id: 2, name: 'Mobile App Development', description: 'Cross-platform mobile application for customer engagement', status: 'active', createdBy: 1, startDate: '2024-02-01', endDate: '2024-08-31' },
            { id: 3, name: 'Data Analytics Dashboard', description: 'Business intelligence dashboard for data visualization', status: 'planning', createdBy: 1, startDate: '2024-03-01', endDate: '2024-09-30' }
        ];

        const defaultTasks = [
            { id: 1, title: 'Setup Project Repository', description: 'Initialize Git repository and setup basic structure', assignee: 2, priority: 'high', status: 'todo', createdBy: 1, dueDate: '2024-01-15', projectId: 1 },
            { id: 2, title: 'Design Database Schema', description: 'Create ERD and design database tables', assignee: 3, priority: 'medium', status: 'ongoing', createdBy: 1, dueDate: '2024-01-20', projectId: 1 },
            { id: 3, title: 'Write API Documentation', description: 'Document all API endpoints and responses', assignee: 2, priority: 'low', status: 'completed', createdBy: 1, dueDate: '2024-01-10', projectId: 1 },
            { id: 4, title: 'UI/UX Design Review', description: 'Review and approve the new dashboard design', assignee: 4, priority: 'high', status: 'review', createdBy: 1, dueDate: '2024-01-18', projectId: 2 },
            { id: 5, title: 'Client Meeting Preparation', description: 'Prepare presentation materials for client meeting', assignee: 4, priority: 'medium', status: 'data-pending', createdBy: 1, dueDate: '2024-01-22', projectId: 2 },
            { id: 6, title: 'Code Refactoring', description: 'Refactor legacy code for better performance', assignee: 3, priority: 'low', status: 'delayed', createdBy: 1, dueDate: '2024-01-12', projectId: 1 },
            { id: 7, title: 'Testing Phase 1', description: 'Complete unit testing for core modules', assignee: 2, priority: 'high', status: 'ongoing', createdBy: 1, dueDate: '2024-01-25', projectId: 1 },
            { id: 8, title: 'Security Audit', description: 'Conduct security review of the application', assignee: 3, priority: 'high', status: 'blocked', createdBy: 1, dueDate: '2024-01-30', projectId: 2 }
        ];
        
        // Load data from localStorage or use defaults
        let users = JSON.parse(localStorage.getItem('brolist_users')) || defaultUsers;
        let projects = JSON.parse(localStorage.getItem('brolist_projects')) || defaultProjects;
        let tasks = JSON.parse(localStorage.getItem('brolist_tasks')) || defaultTasks;
        
        // Save data to localStorage
        function saveData() {
            localStorage.setItem('brolist_users', JSON.stringify(users));
            localStorage.setItem('brolist_projects', JSON.stringify(projects));
            localStorage.setItem('brolist_tasks', JSON.stringify(tasks));
            localStorage.setItem('brolist_notifications', JSON.stringify(notifications));
            localStorage.setItem('brolist_darkMode', JSON.stringify(isDarkMode));
            localStorage.setItem('brolist_messages', JSON.stringify(messages));
            
            // Save current user session
            if (currentUser) {
                localStorage.setItem('brolist_currentUser', JSON.stringify(currentUser));
            }
        }
        
        // Initialize data on first load
        if (!localStorage.getItem('brolist_users')) {
            saveData();
            
            // Add some demo messages for testing
            setTimeout(() => {
                addDemoMessages();
            }, 5000); // Add demo messages after 5 seconds
        }
        
        // Demo message system for testing real-time chat
        function addDemoMessages() {
            if (!currentUser) return;
            
            const demoMessages = [
                { from: 1, to: 2, content: "Hi Ramees! How's the project coming along?" },
                { from: 3, to: 2, content: "Can you review the database schema when you have time?" },
                { from: 4, to: 2, content: "Great work on the API documentation!" },
                { from: 1, to: 3, content: "John, please update the project timeline." },
                { from: 4, to: 1, content: "The client meeting went well. They approved the design." }
            ];
            
            let messageIndex = 0;
            const sendDemoMessage = () => {
                if (messageIndex >= demoMessages.length) return;
                
                const demo = demoMessages[messageIndex];
                const message = {
                    id: Math.max(...messages.map(m => m.id), 0) + 1,
                    senderId: demo.from,
                    receiverId: demo.to,
                    content: demo.content,
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                messages.push(message);
                saveData();
                
                messageIndex++;
                
                // Schedule next message
                if (messageIndex < demoMessages.length) {
                    setTimeout(sendDemoMessage, 10000 + Math.random() * 20000); // 10-30 seconds
                }
            };
            
            // Start sending demo messages
            setTimeout(sendDemoMessage, 3000);
        }

        // Night Mode Functions
        function toggleNightMode() {
            isDarkMode = !isDarkMode;
            applyNightMode();
            saveData();
        }

        function applyNightMode() {
            const body = document.body;
            const nightModeIcon = document.getElementById('nightModeIcon');
            
            if (isDarkMode) {
                body.classList.add('dark');
                // Change icon to sun for light mode
                nightModeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
            } else {
                body.classList.remove('dark');
                // Change icon to moon for dark mode
                nightModeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>';
            }
        }

        // Quote Management
        function getRandomQuote() {
            const randomIndex = Math.floor(Math.random() * quotes.length);
            return quotes[randomIndex];
        }

        function updateQuoteDisplay() {
            const quote = getRandomQuote();
            const quoteBox = document.querySelector('.quote-box .bg-white');
            if (quoteBox) {
                quoteBox.innerHTML = `
                    <p class="text-sm text-gray-700 italic leading-relaxed">
                        "${quote.text}"
                    </p>
                    <p class="text-xs text-gray-500 mt-2 text-right">– ${quote.author}</p>
                `;
            }
        }

        // Refresh Page Function
        function refreshPage() {
            // Re-render all sections based on current view
            if (currentUser) {
                // Reload data from localStorage to get latest updates
                users = JSON.parse(localStorage.getItem('brolist_users')) || defaultUsers;
                projects = JSON.parse(localStorage.getItem('brolist_projects')) || defaultProjects;
                tasks = JSON.parse(localStorage.getItem('brolist_tasks')) || defaultTasks;
                notifications = JSON.parse(localStorage.getItem('rolist_notifications')) || [];
                messages = JSON.parse(localStorage.getItem('brolist_messages')) || [];
                
                // Update current user object with latest data
                const updatedCurrentUser = users.find(u => u.id === currentUser.id);
                if (updatedCurrentUser) {
                    currentUser = updatedCurrentUser;
                    updateAllProfileDisplays();
                }
                
                // Re-render all sections
                renderDashboardCards();
                renderTasks();
                renderProjects();
                renderUsers();
                updateNotificationBadge();
                renderChatUsers();
                
                // If in chat, refresh the current conversation
                if (selectedChatUser) {
                    renderChatMessages();
                }
                
                // Show refresh animation
                const refreshBtn = event.target.closest('button');
                refreshBtn.style.transform = 'rotate(360deg)';
                refreshBtn.style.transition = 'transform 0.5s ease';
                setTimeout(() => {
                    refreshBtn.style.transform = '';
                }, 500);
                
                // Show success message briefly
                const originalTitle = document.querySelector('header h1').textContent;
                document.querySelector('header h1').textContent = 'Refreshed!';
                document.querySelector('header h1').style.color = '#10b981';
                setTimeout(() => {
                    document.querySelector('header h1').textContent = originalTitle;
                    document.querySelector('header h1').style.color = '';
                }, 1000);
            }
        }

        // Initialize night mode on page load
        document.addEventListener('DOMContentLoaded', function() {
            applyNightMode();
            
            // Add night mode toggle event listener
            document.getElementById('nightModeToggle').addEventListener('click', toggleNightMode);
            
            // Check if user was previously logged in
            const savedCurrentUser = localStorage.getItem('brolist_currentUser');
            if (savedCurrentUser) {
                const userData = JSON.parse(savedCurrentUser);
                const user = users.find(u => u.id === userData.id);
                if (user) {
                    currentUser = user;
                    showDashboard();
                    return; // Skip login screen initialization
                }
            }
            
            // Initialize first nav button as active (only if not logged in)
            const firstNavBtn = document.querySelector('.nav-btn');
            if (firstNavBtn) {
                firstNavBtn.classList.add('bg-blue-600', 'text-white');
            }
            
            // Initialize quote display
            updateQuoteDisplay();
        });

        // Utility function to get initials
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }

        // Notification System
        function createNotification(userId, type, message, taskId = null, messageId = null) {
            const notification = {
                id: Math.max(...notifications.map(n => n.id), 0) + 1,
                userId: userId,
                type: type, // 'task_assigned', 'task_status_changed', 'new_message'
                message: message,
                taskId: taskId,
                messageId: messageId,
                read: false,
                createdAt: new Date().toISOString()
            };
            notifications.push(notification);
            saveData();
            updateNotificationBadge();
        }

        function getUserNotifications(userId) {
            return notifications.filter(n => n.userId === userId).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        }

        function markNotificationAsRead(notificationId) {
            const notification = notifications.find(n => n.id === notificationId);
            if (notification) {
                notification.read = true;
                saveData();
                updateNotificationBadge();
            }
        }

        function updateNotificationBadge() {
            if (currentUser) {
                const unreadCount = notifications.filter(n => n.userId === currentUser.id && !n.read).length;
                const badge = document.querySelector('.notification-badge');
                if (badge) {
                    badge.textContent = unreadCount;
                    badge.style.display = unreadCount > 0 ? 'flex' : 'none';
                }
                renderNotifications();
            }
        }

        function renderNotifications() {
            const notificationsList = document.getElementById('notificationsList');
            const userNotifications = getUserNotifications(currentUser.id);
            
            if (userNotifications.length === 0) {
                notificationsList.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">No notifications</div>';
                return;
            }
            
            notificationsList.innerHTML = userNotifications.slice(0, 10).map(notification => {
                const timeAgo = getTimeAgo(new Date(notification.createdAt));
                let iconHtml = '';
                
                // Different icons for different notification types
                if (notification.type === 'task_assigned') {
                    iconHtml = '<div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg></div>';
                } else if (notification.type === 'new_message') {
                    iconHtml = '<div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"></path></svg></div>';
                } else {
                    iconHtml = '<div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></div>';
                }
                
                return `
                    <div class="p-3 hover:bg-gray-50 rounded-lg cursor-pointer ${!notification.read ? 'bg-blue-50 border-l-4 border-blue-500' : ''}" onclick="handleNotificationClick(${notification.id}, '${notification.type}', ${notification.taskId || 'null'}, ${notification.messageId || 'null'})">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                ${iconHtml}
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-gray-800">${notification.message}</p>
                                <p class="text-xs text-gray-500 mt-1">${timeAgo}</p>
                            </div>
                            ${!notification.read ? '<div class="w-2 h-2 bg-blue-500 rounded-full flex-shrink-0"></div>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Handle notification clicks
        function handleNotificationClick(notificationId, type, taskId, messageId) {
            markNotificationAsRead(notificationId);
            
            // Navigate based on notification type
            if (type === 'new_message' && messageId) {
                // Find the message and sender
                const message = messages.find(m => m.id === parseInt(messageId));
                if (message) {
                    const sender = users.find(u => u.id === message.senderId);
                    if (sender) {
                        // Navigate to chat and select the sender
                        showSection('chat');
                        document.querySelectorAll('.nav-btn').forEach(b => {
                            b.classList.remove('bg-blue-600', 'text-white');
                            b.classList.add('text-gray-700', 'hover:bg-gray-200');
                        });
                        document.querySelector('[data-section="chat"]').classList.remove('text-gray-700', 'hover:bg-gray-200');
                        document.querySelector('[data-section="chat"]').classList.add('bg-blue-600', 'text-white');
                        
                        // Select the chat user after a brief delay to ensure UI is ready
                        setTimeout(() => {
                            selectChatUser(sender.id);
                        }, 100);
                    }
                }
            } else if (type === 'task_assigned' && taskId) {
                // Navigate to tasks section
                showSection('tasks');
                document.querySelectorAll('.nav-btn').forEach(b => {
                    b.classList.remove('bg-blue-600', 'text-white');
                    b.classList.add('text-gray-700', 'hover:bg-gray-200');
                });
                document.querySelector('[data-section="tasks"]').classList.remove('text-gray-700', 'hover:bg-gray-200');
                document.querySelector('[data-section="tasks"]').classList.add('bg-blue-600', 'text-white');
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }

        // Login System
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const user = users.find(u => u.email === email && u.password === password);
            
            if (user) {
                currentUser = user;
                saveData(); // Save session immediately after login
                showDashboard();
            } else {
                alert('Invalid credentials. Please try the demo accounts provided.');
            }
        });

        // Dashboard Functions
        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            // Update all profile displays
            updateAllProfileDisplays();
            
            if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                document.getElementById('adminNav').classList.remove('hidden');
            } else {
                document.getElementById('adminNav').classList.add('hidden');
            }
            
            if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                document.getElementById('addTaskBtn').classList.remove('hidden');
                document.getElementById('addProjectBtn').classList.remove('hidden');
            }
            
            updateProfileForm();
            updateNotificationBadge();
            showSection('dashboard');
            renderDashboardCards();
            
            // Show a new random quote on login
            updateQuoteDisplay();
        }

        function updateAllProfileDisplays() {
            const initials = getInitials(currentUser.name);
            
            // Update header
            document.getElementById('dropdownUserName').textContent = currentUser.name;
            document.getElementById('dropdownUserRole').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            
            // Update sidebar
            document.getElementById('sidebarUserName').textContent = currentUser.name;
            document.getElementById('sidebarUserRole').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            
            // Update profile pictures
            updateProfilePictureDisplay();
        }

        // Sidebar Toggle
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            sidebarCollapsed = !sidebarCollapsed;
            
            if (sidebarCollapsed) {
                sidebar.classList.add('sidebar-collapsed');
            } else {
                sidebar.classList.remove('sidebar-collapsed');
            }
        });

        // Navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const section = this.dataset.section;
                showSection(section);
                
                // Update active state
                document.querySelectorAll('.nav-btn').forEach(b => {
                    b.classList.remove('bg-blue-600', 'text-white');
                    b.classList.add('text-gray-700', 'hover:bg-gray-200');
                });
                this.classList.remove('text-gray-700', 'hover:bg-gray-200');
                this.classList.add('bg-blue-600', 'text-white');
            });
        });

        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionName + 'Section').classList.remove('hidden');
            
            // Handle chat section real-time updates
            if (sectionName === 'chat') {
                isInChatSection = true;
                renderChatUsers();
                startChatUpdates();
                requestNotificationPermission(); // Request permission when entering chat
                lastMessageCheck = Date.now(); // Reset message check timestamp
            } else {
                isInChatSection = false;
                if (sectionName !== 'chat') {
                    stopChatUpdates(); // Stop updates when leaving chat
                }
            }
            
            if (sectionName === 'tasks') {
                renderTasks();
            } else if (sectionName === 'projects') {
                renderProjects();
            } else if (sectionName === 'admin') {
                renderUsers();
            } else if (sectionName === 'dashboard') {
                renderDashboardCards();
            }
            
            // Clear task filter when switching away from tasks
            if (sectionName !== 'tasks') {
                window.currentTaskFilter = null;
            }
        }

        // Dashboard Cards Rendering
        function renderDashboardCards() {
            // Calculate real-time task counts
            const taskCounts = {
                'todo': tasks.filter(t => t.status === 'todo').length,
                'ongoing': tasks.filter(t => t.status === 'ongoing').length,
                'completed': tasks.filter(t => t.status === 'completed').length,
                'data-pending': tasks.filter(t => t.status === 'data-pending').length,
                'delayed': tasks.filter(t => t.status === 'delayed').length,
                'blocked': tasks.filter(t => t.status === 'blocked').length,
                'review': tasks.filter(t => t.status === 'review').length
            };

            const cardData = [
                { title: 'To Do', count: taskCounts.todo, color: 'orange', icon: 'clipboard', status: 'todo' },
                { title: 'On Going', count: taskCounts.ongoing, color: 'blue', icon: 'clock', status: 'ongoing' },
                { title: 'Completed', count: taskCounts.completed, color: 'green', icon: 'check', status: 'completed' },
                { title: 'Data Pending', count: taskCounts['data-pending'], color: 'yellow', icon: 'exclamation', status: 'data-pending' },
                { title: 'Delayed', count: taskCounts.delayed, color: 'red', icon: 'warning', status: 'delayed' },
                { title: 'Blocked', count: taskCounts.blocked, color: 'gray', icon: 'pause', status: 'blocked' },
                { title: 'In Review', count: taskCounts.review, color: 'indigo', icon: 'check-circle', status: 'review' }
            ];

            const iconsMap = {
                clipboard: 'M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2',
                clock: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z',
                check: 'M5 13l4 4L19 7',
                'check-circle': 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z',
                exclamation: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z',
                warning: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z',
                pause: 'M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z'
            };

            const cardsContainer = document.getElementById('dashboardTaskCards');
            cardsContainer.innerHTML = cardData.map(card => `
                <div class="task-card rounded-lg p-4 shadow-sm hover-scale cursor-pointer transition-all duration-200" onclick="showTaskDetails('${card.status}')">
                    <div class="flex flex-col items-center text-center">
                        <div class="w-10 h-10 bg-${card.color}-100 rounded-full flex items-center justify-center mb-2">
                            <svg class="w-5 h-5 text-${card.color}-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconsMap[card.icon]}"></path>
                            </svg>
                        </div>
                        <h3 class="text-sm font-medium text-gray-800 mb-1">${card.title}</h3>
                        <p class="text-2xl font-bold text-${card.color}-600 mb-1">${card.count}</p>
                        <p class="text-xs text-gray-500">tasks</p>
                    </div>
                </div>
            `).join('');
        }

        function filterTasksByStatus(status) {
            // Store the filter status globally
            window.currentTaskFilter = status;
            
            showSection('tasks');
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white');
                b.classList.add('text-gray-700', 'hover:bg-gray-200');
            });
            document.querySelector('[data-section="tasks"]').classList.remove('text-gray-700', 'hover:bg-gray-200');
            document.querySelector('[data-section="tasks"]').classList.add('bg-blue-600', 'text-white');
            
            // Re-render tasks with filter
            renderTasks();
        }

        function showTodaysTasks() {
            const today = new Date().toISOString().split('T')[0];
            window.currentTaskFilter = null;
            window.currentProjectFilter = null;
            window.currentDateFilter = today;
            
            showSection('tasks');
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white');
                b.classList.add('text-gray-700', 'hover:bg-gray-200');
            });
            document.querySelector('[data-section="tasks"]').classList.remove('text-gray-700', 'hover:bg-gray-200');
            document.querySelector('[data-section="tasks"]').classList.add('bg-blue-600', 'text-white');
            
            renderTasks();
        }

        // Project Management
        function renderProjects() {
            const projectsList = document.getElementById('projectsList');
            const userProjects = currentUser.role === 'admin' ? projects : projects.filter(p => {
                // Show projects that have tasks assigned to the user
                return tasks.some(t => t.projectId === p.id && t.assignee === currentUser.id);
            });
            
            projectsList.innerHTML = userProjects.map(project => {
                const projectTasks = tasks.filter(t => t.projectId === project.id);
                const completedTasks = projectTasks.filter(t => t.status === 'completed').length;
                const totalTasks = projectTasks.length;
                const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                
                const statusColors = {
                    active: 'bg-green-100 text-green-800',
                    planning: 'bg-yellow-100 text-yellow-800',
                    completed: 'bg-blue-100 text-blue-800',
                    on_hold: 'bg-gray-100 text-gray-800'
                };
                
                return `
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex-1">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-2">${project.name}</h3>
                                    <p class="text-gray-600 mb-3">${project.description}</p>
                                    <div class="flex items-center space-x-4 text-sm text-gray-500">
                                        <span>Start: ${new Date(project.startDate).toLocaleDateString()}</span>
                                        <span>End: ${new Date(project.endDate).toLocaleDateString()}</span>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end space-y-2">
                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${statusColors[project.status]}">${project.status}</span>
                                    <div class="text-right">
                                        <div class="text-sm font-medium text-gray-800">${progress}% Complete</div>
                                        <div class="text-xs text-gray-500">${completedTasks}/${totalTasks} tasks</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="mb-4">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex items-center justify-between">
                                <div class="flex space-x-3">
                                    <button onclick="viewProjectTasks(${project.id})" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                        View Tasks (${totalTasks})
                                    </button>
                                    ${(currentUser.role === 'admin' || currentUser.role === 'manager') ? `
                                        <button onclick="addTaskToProject(${project.id})" class="text-green-600 hover:text-green-800 text-sm font-medium">
                                            + Add Task
                                        </button>
                                    ` : ''}
                                </div>
                                ${(currentUser.role === 'admin' || currentUser.role === 'manager') ? `
                                    <div class="flex space-x-2">
                                        <button onclick="editProject(${project.id})" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                                        <button onclick="deleteProject(${project.id})" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Recent Tasks Preview -->
                        ${projectTasks.length > 0 ? `
                            <div class="border-t border-gray-100 bg-gray-50 p-4">
                                <h4 class="text-sm font-medium text-gray-700 mb-2">Recent Tasks</h4>
                                <div class="space-y-2">
                                    ${projectTasks.slice(0, 3).map(task => {
                                        const assignee = users.find(u => u.id === task.assignee);
                                        const statusColors = {
                                            todo: 'bg-gray-100 text-gray-800',
                                            ongoing: 'bg-blue-100 text-blue-800',
                                            completed: 'bg-green-100 text-green-800',
                                            delayed: 'bg-red-100 text-red-800',
                                            'data-pending': 'bg-yellow-100 text-yellow-800',
                                            review: 'bg-purple-100 text-purple-800',
                                            blocked: 'bg-orange-100 text-orange-800'
                                        };
                                        return `
                                            <div class="flex items-center justify-between text-sm">
                                                <span class="text-gray-700 truncate flex-1">${task.title}</span>
                                                <div class="flex items-center space-x-2 ml-2">
                                                    <span class="text-xs text-gray-500">${assignee ? assignee.name : 'Unassigned'}</span>
                                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[task.status]}">${task.status.replace('-', ' ')}</span>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                    ${projectTasks.length > 3 ? `<div class="text-xs text-gray-500 text-center">+${projectTasks.length - 3} more tasks</div>` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Task Management
        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            let userTasks = currentUser.role === 'admin' ? tasks : tasks.filter(t => t.assignee === currentUser.id);
            
            // Apply filters if set
            let headerText = 'Tasks';
            let showClearButton = false;
            
            if (window.currentDateFilter) {
                userTasks = userTasks.filter(t => t.dueDate === window.currentDateFilter);
                headerText = `Today's Tasks (${userTasks.length})`;
                showClearButton = true;
            }
            
            if (window.currentProjectFilter) {
                userTasks = userTasks.filter(t => t.projectId === window.currentProjectFilter);
                const project = projects.find(p => p.id === window.currentProjectFilter);
                headerText = `Tasks - ${project ? project.name : 'Unknown Project'} (${userTasks.length})`;
                showClearButton = true;
            }
            
            if (window.currentTaskFilter) {
                userTasks = userTasks.filter(t => t.status === window.currentTaskFilter);
                const statusDisplayNames = {
                    'todo': 'To Do',
                    'ongoing': 'On Going', 
                    'completed': 'Completed',
                    'data-pending': 'Data Pending',
                    'delayed': 'Delayed',
                    'blocked': 'Blocked',
                    'review': 'In Review'
                };
                
                if (window.currentProjectFilter) {
                    const project = projects.find(p => p.id === window.currentProjectFilter);
                    headerText = `Tasks - ${project ? project.name : 'Unknown Project'} - ${statusDisplayNames[window.currentTaskFilter]} (${userTasks.length})`;
                } else if (window.currentDateFilter) {
                    headerText = `Today's Tasks - ${statusDisplayNames[window.currentTaskFilter]} (${userTasks.length})`;
                } else {
                    headerText = `Tasks - ${statusDisplayNames[window.currentTaskFilter]} (${userTasks.length})`;
                }
                showClearButton = true;
            }
            
            // Update header and clear button
            document.querySelector('#tasksSection h2').innerHTML = headerText;
            if (showClearButton) {
                document.getElementById('clearFilterBtn').classList.remove('hidden');
            } else {
                document.getElementById('clearFilterBtn').classList.add('hidden');
            }
            
            tasksList.innerHTML = userTasks.map(task => {
                const assignee = users.find(u => u.id === task.assignee);
                const priorityColors = {
                    low: 'bg-green-100 text-green-800',
                    medium: 'bg-yellow-100 text-yellow-800',
                    high: 'bg-red-100 text-red-800'
                };
                const statusColors = {
                    todo: 'bg-gray-100 text-gray-800',
                    ongoing: 'bg-blue-100 text-blue-800',
                    completed: 'bg-green-100 text-green-800',
                    delayed: 'bg-red-100 text-red-800',
                    'data-pending': 'bg-yellow-100 text-yellow-800',
                    review: 'bg-purple-100 text-purple-800',
                    blocked: 'bg-orange-100 text-orange-800'
                };
                
                const isOverdue = new Date(task.dueDate) < new Date() && task.status !== 'completed';
                const dueDateClass = isOverdue ? 'text-red-600 font-medium' : 'text-gray-500';
                
                return `
                    <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
                        <div class="flex items-start justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-800">${task.title}</h3>
                            <div class="flex space-x-2">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${priorityColors[task.priority]}">${task.priority}</span>
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[task.status]}">${task.status.replace('-', ' ')}</span>
                            </div>
                        </div>
                        <p class="text-gray-600 mb-3">${task.description}</p>
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex flex-col space-y-1">
                                <span class="text-sm text-gray-500">Assigned to: ${assignee ? assignee.name : 'Unknown'}</span>
                                <span class="text-sm text-blue-600">Project: ${projects.find(p => p.id === task.projectId)?.name || 'Unknown Project'}</span>
                            </div>
                            <span class="text-sm ${dueDateClass}">Due: ${new Date(task.dueDate).toLocaleDateString()}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex space-x-2">
                                ${(currentUser.role === 'admin' || currentUser.role === 'manager' || task.assignee === currentUser.id) ? `
                                    <button onclick="editTask(${task.id})" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                                ` : ''}
                                ${(currentUser.role === 'admin' || currentUser.role === 'manager') ? `
                                    <button onclick="deleteTask(${task.id})" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                                ` : ''}
                            </div>
                            ${(task.assignee === currentUser.id || (currentUser.role === 'admin' && task.assignee !== users.find(u => u.role === 'manager')?.id)) ? `
                                <select onchange="updateTaskStatus(${task.id}, this.value)" class="px-3 py-1 border border-gray-300 rounded text-sm">
                                    <option value="todo" ${task.status === 'todo' ? 'selected' : ''}>To Do</option>
                                    <option value="ongoing" ${task.status === 'ongoing' ? 'selected' : ''}>Ongoing</option>
                                    <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                                    <option value="delayed" ${task.status === 'delayed' ? 'selected' : ''}>Delayed</option>
                                    <option value="data-pending" ${task.status === 'data-pending' ? 'selected' : ''}>Data Pending</option>
                                    <option value="review" ${task.status === 'review' ? 'selected' : ''}>Under Review</option>
                                    <option value="blocked" ${task.status === 'blocked' ? 'selected' : ''}>Blocked</option>
                                </select>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateTaskStatus(taskId, newStatus) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                const oldStatus = task.status;
                task.status = newStatus;
                
                // Create notification for admin and task creator if status changed by assignee
                if (currentUser.id === task.assignee && currentUser.role !== 'admin') {
                    const admin = users.find(u => u.role === 'admin');
                    const creator = users.find(u => u.id === task.createdBy);
                    
                    if (admin) {
                        createNotification(
                            admin.id,
                            'task_status_changed',
                            `${currentUser.name} changed task "${task.title}" status from ${oldStatus.replace('-', ' ')} to ${newStatus.replace('-', ' ')}`,
                            taskId
                        );
                    }
                    
                    if (creator && creator.id !== admin.id) {
                        createNotification(
                            creator.id,
                            'task_status_changed',
                            `${currentUser.name} changed task "${task.title}" status from ${oldStatus.replace('-', ' ')} to ${newStatus.replace('-', ' ')}`,
                            taskId
                        );
                    }
                }
                
                saveData();
                renderTasks();
                renderDashboardCards(); // Update dashboard counts
            }
        }

        // Project Modal
        document.getElementById('addProjectBtn').addEventListener('click', function() {
            document.getElementById('projectModal').classList.remove('hidden');
        });

        document.getElementById('cancelProjectBtn').addEventListener('click', function() {
            document.getElementById('projectModal').classList.add('hidden');
            document.getElementById('projectForm').reset();
        });

        document.getElementById('projectForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (window.editingProjectId) {
                // Update existing project
                const projectIndex = projects.findIndex(p => p.id === window.editingProjectId);
                if (projectIndex !== -1) {
                    projects[projectIndex] = {
                        ...projects[projectIndex],
                        name: document.getElementById('projectName').value,
                        description: document.getElementById('projectDescription').value,
                        startDate: document.getElementById('projectStartDate').value,
                        endDate: document.getElementById('projectEndDate').value
                    };
                }
                window.editingProjectId = null;
            } else {
                // Create new project
                const newProject = {
                    id: Math.max(...projects.map(p => p.id), 0) + 1,
                    name: document.getElementById('projectName').value,
                    description: document.getElementById('projectDescription').value,
                    status: 'active',
                    createdBy: currentUser.id,
                    startDate: document.getElementById('projectStartDate').value,
                    endDate: document.getElementById('projectEndDate').value
                };
                
                projects.push(newProject);
            }
            
            saveData();
            document.getElementById('projectModal').classList.add('hidden');
            document.getElementById('projectForm').reset();
            
            // Reset modal title and button
            document.querySelector('#projectModal h3').textContent = 'Add New Project';
            document.querySelector('#projectForm button[type="submit"]').textContent = 'Create Project';
            
            renderProjects();
        });

        // Task Modal
        document.getElementById('addTaskBtn').addEventListener('click', function() {
            populateAssigneeDropdown();
            populateProjectDropdown();
            document.getElementById('taskModal').classList.remove('hidden');
        });

        document.getElementById('cancelTaskBtn').addEventListener('click', function() {
            document.getElementById('taskModal').classList.add('hidden');
            document.getElementById('taskForm').reset();
        });

        document.getElementById('taskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (window.editingTaskId) {
                // Update existing task
                const taskIndex = tasks.findIndex(t => t.id === window.editingTaskId);
                if (taskIndex !== -1) {
                    const oldAssignee = tasks[taskIndex].assignee;
                    const newAssignee = parseInt(document.getElementById('taskAssignee').value);
                    
                    tasks[taskIndex] = {
                        ...tasks[taskIndex],
                        title: document.getElementById('taskTitle').value,
                        description: document.getElementById('taskDescription').value,
                        projectId: parseInt(document.getElementById('taskProject').value),
                        assignee: newAssignee,
                        priority: document.getElementById('taskPriority').value,
                        dueDate: document.getElementById('taskDueDate').value
                    };
                    
                    // Create notification if assignee changed
                    if (oldAssignee !== newAssignee && newAssignee !== currentUser.id) {
                        const assignedUser = users.find(u => u.id === newAssignee);
                        if (assignedUser) {
                            createNotification(
                                newAssignee,
                                'task_assigned',
                                `Task "${tasks[taskIndex].title}" has been reassigned to you by ${currentUser.name}`,
                                tasks[taskIndex].id
                            );
                        }
                    }
                }
                window.editingTaskId = null;
            } else {
                // Create new task
                const newTask = {
                    id: Math.max(...tasks.map(t => t.id), 0) + 1,
                    title: document.getElementById('taskTitle').value,
                    description: document.getElementById('taskDescription').value,
                    projectId: parseInt(document.getElementById('taskProject').value),
                    assignee: parseInt(document.getElementById('taskAssignee').value),
                    priority: document.getElementById('taskPriority').value,
                    status: 'todo',
                    createdBy: currentUser.id,
                    dueDate: document.getElementById('taskDueDate').value
                };
                
                tasks.push(newTask);
                
                // Create notification for assigned user
                if (newTask.assignee !== currentUser.id) {
                    const assignedUser = users.find(u => u.id === newTask.assignee);
                    if (assignedUser) {
                        createNotification(
                            newTask.assignee,
                            'task_assigned',
                            `You have been assigned a new task: "${newTask.title}" by ${currentUser.name}`,
                            newTask.id
                        );
                    }
                }
            }
            
            saveData();
            document.getElementById('taskModal').classList.add('hidden');
            document.getElementById('taskForm').reset();
            
            // Reset modal title and button
            document.querySelector('#taskModal h3').textContent = 'Add New Task';
            document.querySelector('#taskForm button[type="submit"]').textContent = 'Create Task';
            
            renderTasks();
            renderDashboardCards();
        });

        function populateAssigneeDropdown() {
            const select = document.getElementById('taskAssignee');
            let availableUsers = [];
            
            if (currentUser.role === 'manager') {
                // Manager can assign to everyone including admin
                availableUsers = users;
            } else if (currentUser.role === 'admin') {
                // Admin can assign to everyone except manager
                availableUsers = users.filter(u => u.role !== 'manager');
            } else {
                // Other roles can't assign tasks
                availableUsers = [];
            }
            
            select.innerHTML = availableUsers.map(user => 
                `<option value="${user.id}">${user.name} (${user.role})</option>`
            ).join('');
        }

        function populateProjectDropdown() {
            const select = document.getElementById('taskProject');
            const activeProjects = projects.filter(p => p.status === 'active' || p.status === 'planning');
            select.innerHTML = activeProjects.map(project => 
                `<option value="${project.id}">${project.name}</option>`
            ).join('');
        }

        // User Management
        function renderUsers() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = users.map(user => {
                const avatarStyle = user.profilePicture && user.profilePicture.startsWith('data:image') 
                    ? `style="background-image: url(${user.profilePicture}); background-size: cover; background-position: center;"` 
                    : '';
                const avatarContent = user.profilePicture && user.profilePicture.startsWith('data:image') 
                    ? '' 
                    : getInitials(user.name);
                
                return `
                <tr>
                    <td class="px-6 py-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold text-sm" ${avatarStyle}>
                                ${avatarContent}
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900">${user.name}</div>
                                <div class="text-sm text-gray-500">${user.email}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">${user.phone || 'Not provided'}</div>
                        <div class="text-sm text-gray-500">${user.address ? user.address.substring(0, 30) + (user.address.length > 30 ? '...' : '') : 'No address'}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${user.role === 'admin' ? 'bg-purple-100 text-purple-800' : user.role === 'trainee' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">
                            ${user.role}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm">
                        <div class="flex space-x-2">
                            <button onclick="viewUserProfile(${user.id})" class="text-blue-600 hover:text-blue-800">View</button>
                            <button onclick="editUser(${user.id})" class="text-green-600 hover:text-green-800">Edit</button>
                            ${user.id !== currentUser.id ? `
                                <button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-800">Delete</button>
                            ` : ''}
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function viewUserProfile(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                alert(`User Profile:\n\nName: ${user.name}\nEmail: ${user.email}\nPhone: ${user.phone || 'Not provided'}\nAddress: ${user.address || 'Not provided'}\nRole: ${user.role}`);
            }
        }

        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                users = users.filter(u => u.id !== userId);
                saveData();
                renderUsers();
            }
        }

        // User Modal
        document.getElementById('addUserBtn').addEventListener('click', function() {
            editingUserId = null;
            
            // Reset modal for adding new user
            document.getElementById('userModalTitle').textContent = 'Add New User';
            document.getElementById('userSubmitBtn').textContent = 'Create User';
            document.getElementById('userSubmitBtn').className = 'flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors';
            
            // Clear form
            document.getElementById('userForm').reset();
            window.newUserProfilePicture = null;
            window.editUserProfilePicture = null;
            
            document.getElementById('userModal').classList.remove('hidden');
        });

        document.getElementById('cancelUserBtn').addEventListener('click', function() {
            document.getElementById('userModal').classList.add('hidden');
            document.getElementById('userForm').reset();
            editingUserId = null;
            window.newUserProfilePicture = null;
            window.editUserProfilePicture = null;
        });

        // Handle user profile picture file selection
        document.getElementById('userProfilePicture').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    alert('File size must be less than 5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Store the image data temporarily
                    window.newUserProfilePicture = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('userForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (editingUserId) {
                // Update existing user
                const userIndex = users.findIndex(u => u.id === editingUserId);
                if (userIndex !== -1) {
                    users[userIndex] = {
                        ...users[userIndex],
                        name: document.getElementById('userName').value,
                        email: document.getElementById('userEmail').value,
                        password: document.getElementById('userPassword').value,
                        phone: document.getElementById('userPhone').value,
                        address: document.getElementById('userAddress').value,
                        profilePicture: window.newUserProfilePicture || window.editUserProfilePicture || users[userIndex].profilePicture,
                        role: document.getElementById('userRole').value === 'custom' ? 
                              document.getElementById('customRoleInput').value : 
                              document.getElementById('userRole').value
                    };
                    
                    // If editing current user, update currentUser object
                    if (editingUserId === currentUser.id) {
                        currentUser = users[userIndex];
                        updateAllProfileDisplays();
                    }
                }
                editingUserId = null;
            } else {
                // Create new user
                const newUser = {
                    id: Math.max(...users.map(u => u.id), 0) + 1,
                    name: document.getElementById('userName').value,
                    email: document.getElementById('userEmail').value,
                    password: document.getElementById('userPassword').value,
                    phone: document.getElementById('userPhone').value,
                    address: document.getElementById('userAddress').value,
                    profilePicture: window.newUserProfilePicture || '',
                    role: document.getElementById('userRole').value === 'custom' ? 
                          document.getElementById('customRoleInput').value : 
                          document.getElementById('userRole').value
                };
                
                users.push(newUser);
            }
            
            saveData();
            document.getElementById('userModal').classList.add('hidden');
            document.getElementById('userForm').reset();
            window.newUserProfilePicture = null;
            window.editUserProfilePicture = null;
            renderUsers();
        });

        // Profile Management
        function updateProfileForm() {
            document.getElementById('profileName').value = currentUser.name;
            document.getElementById('profileEmail').value = currentUser.email;
            document.getElementById('profilePhone').value = currentUser.phone || '';
            document.getElementById('profileAddress').value = currentUser.address || '';
            
            // Update display elements
            document.getElementById('profileDisplayName').textContent = currentUser.name;
            document.getElementById('profileDisplayRole').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            
            // Update profile picture display
            updateProfilePictureDisplay();
        }

        function updateProfilePictureDisplay() {
            const avatars = document.querySelectorAll('#profileAvatar, #sidebarAvatar, #headerProfileBtn');
            const initials = getInitials(currentUser.name);
            
            avatars.forEach(avatar => {
                if (currentUser.profilePicture && currentUser.profilePicture.startsWith('data:image')) {
                    avatar.style.backgroundImage = `url(${currentUser.profilePicture})`;
                    avatar.style.backgroundSize = 'cover';
                    avatar.style.backgroundPosition = 'center';
                    avatar.innerHTML = '';
                } else {
                    avatar.style.backgroundImage = '';
                    avatar.innerHTML = `<span>${initials}</span>`;
                }
            });
        }

        // Handle profile picture file selection
        document.getElementById('profilePictureFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    alert('File size must be less than 5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentUser.profilePicture = e.target.result;
                    updateProfilePictureDisplay();
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('updateProfileBtn').addEventListener('click', function() {
            currentUser.name = document.getElementById('profileName').value;
            currentUser.email = document.getElementById('profileEmail').value;
            currentUser.phone = document.getElementById('profilePhone').value;
            currentUser.address = document.getElementById('profileAddress').value;
            
            // Update the user in the users array
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = { ...currentUser };
            }
            
            saveData();
            updateAllProfileDisplays();
            updateProfileForm();
            alert('Profile updated successfully!');
        });

        document.getElementById('cancelProfileBtn').addEventListener('click', function() {
            updateProfileForm(); // Reset to original values
        });

        // Profile corner navigation
        function goToProfile() {
            showSection('profile');
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white');
                b.classList.add('text-gray-700', 'hover:bg-gray-200');
            });
            document.querySelector('[data-section="profile"]').classList.remove('text-gray-700', 'hover:bg-gray-200');
            document.querySelector('[data-section="profile"]').classList.add('bg-blue-600', 'text-white');
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', function() {
            currentUser = null;
            selectedChatUser = null;
            sidebarCollapsed = false;
            
            // Clear session from localStorage
            localStorage.removeItem('brolist_currentUser');
            
            document.getElementById('sidebar').classList.remove('sidebar-collapsed');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginForm').reset();
            
            // Reset any filters
            window.currentTaskFilter = null;
            window.currentProjectFilter = null;
            window.currentDateFilter = null;
        });

        // Placeholder functions for missing features
        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Populate dropdowns first
            populateAssigneeDropdown();
            populateProjectDropdown();
            
            // Populate form with task data
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskDescription').value = task.description;
            document.getElementById('taskProject').value = task.projectId;
            document.getElementById('taskAssignee').value = task.assignee;
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskDueDate').value = task.dueDate;
            
            // Store the task ID for editing
            window.editingTaskId = taskId;
            
            // Update modal title and button
            document.querySelector('#taskModal h3').textContent = 'Edit Task';
            document.querySelector('#taskForm button[type="submit"]').textContent = 'Update Task';
            
            document.getElementById('taskModal').classList.remove('hidden');
        }

        function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                tasks = tasks.filter(t => t.id !== taskId);
                saveData();
                renderTasks();
                renderDashboardCards();
            }
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            editingUserId = userId;
            
            // Update modal title and button
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('userSubmitBtn').textContent = 'Update User';
            document.getElementById('userSubmitBtn').className = 'flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors';
            
            // Populate form with user data
            document.getElementById('userName').value = user.name;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userPassword').value = user.password;
            document.getElementById('userPhone').value = user.phone || '';
            document.getElementById('userAddress').value = user.address || '';
            
            // Handle custom roles
            const standardRoles = ['staff', 'admin', 'trainee', 'manager'];
            if (standardRoles.includes(user.role)) {
                document.getElementById('userRole').value = user.role;
                document.getElementById('customRoleInput').classList.add('hidden');
                document.getElementById('customRoleInput').required = false;
            } else {
                document.getElementById('userRole').value = 'custom';
                document.getElementById('customRoleInput').value = user.role;
                document.getElementById('customRoleInput').classList.remove('hidden');
                document.getElementById('customRoleInput').required = true;
            }
            
            // Store current profile picture
            window.editUserProfilePicture = user.profilePicture;
            
            // Show modal
            document.getElementById('userModal').classList.remove('hidden');
        }

        // Project Functions
        function viewProjectTasks(projectId) {
            window.currentProjectFilter = projectId;
            showSection('tasks');
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white');
                b.classList.add('text-gray-700', 'hover:bg-gray-200');
            });
            document.querySelector('[data-section="tasks"]').classList.remove('text-gray-700', 'hover:bg-gray-200');
            document.querySelector('[data-section="tasks"]').classList.add('bg-blue-600', 'text-white');
            renderTasks();
        }

        function addTaskToProject(projectId) {
            window.selectedProjectId = projectId;
            populateAssigneeDropdown();
            populateProjectDropdown();
            // Pre-select the project
            setTimeout(() => {
                document.getElementById('taskProject').value = projectId;
            }, 100);
            document.getElementById('taskModal').classList.remove('hidden');
        }

        function editProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            // Populate form with project data
            document.getElementById('projectName').value = project.name;
            document.getElementById('projectDescription').value = project.description;
            document.getElementById('projectStartDate').value = project.startDate;
            document.getElementById('projectEndDate').value = project.endDate;
            
            // Store the project ID for editing
            window.editingProjectId = projectId;
            
            // Update modal title and button
            document.querySelector('#projectModal h3').textContent = 'Edit Project';
            document.querySelector('#projectForm button[type="submit"]').textContent = 'Update Project';
            
            document.getElementById('projectModal').classList.remove('hidden');
        }

        function deleteProject(projectId) {
            if (confirm('Are you sure you want to delete this project? All associated tasks will also be deleted.')) {
                projects = projects.filter(p => p.id !== projectId);
                tasks = tasks.filter(t => t.projectId !== projectId);
                saveData();
                renderProjects();
                renderDashboardCards();
            }
        }

        // Clear task filter function
        function clearTaskFilter() {
            window.currentTaskFilter = null;
            window.currentProjectFilter = null;
            window.currentDateFilter = null;
            renderTasks();
        }

        // Task Details Modal Functions
        function showTaskDetails(status) {
            const statusTasks = tasks.filter(t => {
                if (currentUser.role === 'admin') {
                    return t.status === status;
                } else {
                    return t.status === status && t.assignee === currentUser.id;
                }
            });
            
            const statusDisplayNames = {
                'todo': 'To Do',
                'ongoing': 'On Going', 
                'completed': 'Completed',
                'data-pending': 'Data Pending',
                'delayed': 'Delayed',
                'blocked': 'Blocked',
                'review': 'In Review'
            };
            
            const statusColors = {
                todo: 'bg-gray-100 text-gray-800',
                ongoing: 'bg-blue-100 text-blue-800',
                completed: 'bg-green-100 text-green-800',
                delayed: 'bg-red-100 text-red-800',
                'data-pending': 'bg-yellow-100 text-yellow-800',
                review: 'bg-purple-100 text-purple-800',
                blocked: 'bg-orange-100 text-orange-800'
            };
            
            const priorityColors = {
                low: 'bg-green-100 text-green-800',
                medium: 'bg-yellow-100 text-yellow-800',
                high: 'bg-red-100 text-red-800'
            };
            
            const content = `
                <div class="mb-4">
                    <h4 class="text-xl font-semibold text-gray-800 mb-2">${statusDisplayNames[status]} Tasks</h4>
                    <p class="text-gray-600">Total: ${statusTasks.length} tasks</p>
                </div>
                
                ${statusTasks.length === 0 ? 
                    '<div class="text-center py-8 text-gray-500">No tasks found in this category</div>' :
                    `<div class="space-y-4 max-h-96 overflow-y-auto">
                        ${statusTasks.map(task => {
                            const assignee = users.find(u => u.id === task.assignee);
                            const project = projects.find(p => p.id === task.projectId);
                            const isOverdue = new Date(task.dueDate) < new Date() && task.status !== 'completed';
                            const dueDateClass = isOverdue ? 'text-red-600 font-medium' : 'text-gray-500';
                            
                            return `
                                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                    <div class="flex items-start justify-between mb-2">
                                        <h5 class="font-semibold text-gray-800">${task.title}</h5>
                                        <div class="flex space-x-2">
                                            <span class="px-2 py-1 rounded-full text-xs font-medium ${priorityColors[task.priority]}">${task.priority}</span>
                                            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[task.status]}">${task.status.replace('-', ' ')}</span>
                                        </div>
                                    </div>
                                    <p class="text-gray-600 text-sm mb-3">${task.description}</p>
                                    <div class="flex items-center justify-between text-sm">
                                        <div class="space-y-1">
                                            <div class="text-gray-500">Assigned to: ${assignee ? assignee.name : 'Unknown'}</div>
                                            <div class="text-blue-600">Project: ${project ? project.name : 'Unknown Project'}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="${dueDateClass}">Due: ${new Date(task.dueDate).toLocaleDateString()}</div>
                                            ${isOverdue ? '<div class="text-red-500 text-xs font-medium">OVERDUE</div>' : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>`
                }
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button onclick="filterTasksByStatus('${status}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        View All ${statusDisplayNames[status]} Tasks
                    </button>
                    <button onclick="closeTaskDetailsModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                        Close
                    </button>
                </div>
            `;
            
            document.getElementById('taskDetailsContent').innerHTML = content;
            document.getElementById('taskDetailsModal').classList.remove('hidden');
        }
        
        function closeTaskDetailsModal() {
            document.getElementById('taskDetailsModal').classList.add('hidden');
        }

        // Custom role functions
        function toggleCustomRole() {
            const roleSelect = document.getElementById('userRole');
            const customInput = document.getElementById('customRoleInput');
            
            if (roleSelect.value === 'custom') {
                customInput.classList.remove('hidden');
                customInput.required = true;
            } else {
                customInput.classList.add('hidden');
                customInput.required = false;
                customInput.value = '';
            }
        }

        // Real-time Chat System
        let lastMessageCheck = 0;
        let chatUpdateInterval = null;
        let isInChatSection = false;
        
        // Start real-time updates when entering chat
        function startChatUpdates() {
            if (chatUpdateInterval) return; // Already running
            
            chatUpdateInterval = setInterval(() => {
                if (currentUser && isInChatSection) {
                    checkForNewMessages();
                }
            }, 2000); // Check every 2 seconds
        }
        
        // Stop real-time updates when leaving chat
        function stopChatUpdates() {
            if (chatUpdateInterval) {
                clearInterval(chatUpdateInterval);
                chatUpdateInterval = null;
            }
        }
        
        // Check for new messages and update UI
        function checkForNewMessages() {
            // Reload messages from localStorage to get updates from other "users"
            const latestMessages = JSON.parse(localStorage.getItem('brolist_messages')) || [];
            const newMessages = latestMessages.filter(m => 
                new Date(m.timestamp).getTime() > lastMessageCheck &&
                m.receiverId === currentUser.id
            );
            
            if (newMessages.length > 0) {
                // Update local messages array
                messages = latestMessages;
                
                // Create notifications for new messages
                newMessages.forEach(message => {
                    const sender = users.find(u => u.id === message.senderId);
                    if (sender) {
                        createNotification(
                            currentUser.id,
                            'new_message',
                            `New message from ${sender.name}: ${message.content.substring(0, 50)}${message.content.length > 50 ? '...' : ''}`,
                            message.id
                        );
                        
                        // Show browser notification if supported
                        showBrowserNotification(`New message from ${sender.name}`, message.content);
                    }
                });
                
                // Update chat UI
                renderChatUsers();
                if (selectedChatUser) {
                    renderChatMessages();
                }
                
                // Play notification sound (visual feedback)
                showNewMessageIndicator();
            }
            
            lastMessageCheck = Date.now();
        }
        
        // Show visual indicator for new messages
        function showNewMessageIndicator() {
            const chatNavBtn = document.querySelector('[data-section="chat"]');
            if (chatNavBtn && !chatNavBtn.classList.contains('bg-blue-600')) {
                // Add pulsing effect to chat button
                chatNavBtn.style.animation = 'pulse 1s infinite';
                setTimeout(() => {
                    chatNavBtn.style.animation = '';
                }, 3000);
            }
        }
        
        // Browser notification support
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }
        
        function showBrowserNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%234F46E5"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"/></svg>',
                    tag: 'brolist-message'
                });
                
                // Auto close after 4 seconds
                setTimeout(() => notification.close(), 4000);
            }
        }

        // Chat Functions
        function renderChatUsers() {
            const chatUsersList = document.getElementById('chatUsersList');
            const otherUsers = users.filter(u => u.id !== currentUser.id);
            
            chatUsersList.innerHTML = otherUsers.map(user => {
                const lastMessage = getLastMessage(currentUser.id, user.id);
                const unreadCount = getUnreadMessageCount(currentUser.id, user.id);
                const avatarStyle = user.profilePicture && user.profilePicture.startsWith('data:image') 
                    ? `style="background-image: url(${user.profilePicture}); background-size: cover; background-position: center;"` 
                    : '';
                const avatarContent = user.profilePicture && user.profilePicture.startsWith('data:image') 
                    ? '' 
                    : getInitials(user.name);
                
                // Show online status (simulated)
                const isOnline = Math.random() > 0.3; // 70% chance of being "online"
                
                return `
                    <div class="p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors ${selectedChatUser && selectedChatUser.id === user.id ? 'bg-blue-50 border-blue-200' : ''}" onclick="selectChatUser(${user.id})">
                        <div class="flex items-center space-x-3">
                            <div class="relative">
                                <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold" ${avatarStyle}>
                                    ${avatarContent}
                                </div>
                                <!-- Online status indicator -->
                                <div class="absolute bottom-0 right-0 w-3 h-3 ${isOnline ? 'bg-green-400' : 'bg-gray-400'} rounded-full border-2 border-white"></div>
                                ${unreadCount > 0 ? `<div class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-xs text-white">${unreadCount}</div>` : ''}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between">
                                    <h4 class="font-medium text-gray-800 truncate">${user.name}</h4>
                                    <div class="flex flex-col items-end">
                                        <span class="text-xs text-gray-500">${user.role}</span>
                                        ${lastMessage ? `<span class="text-xs text-gray-400">${getTimeAgo(new Date(lastMessage.timestamp))}</span>` : ''}
                                    </div>
                                </div>
                                <div class="flex items-center justify-between mt-1">
                                    <p class="text-sm text-gray-500 truncate flex-1">
                                        ${lastMessage ? 
                                            (lastMessage.senderId === currentUser.id ? 'You: ' : '') + lastMessage.content 
                                            : 'No messages yet'}
                                    </p>
                                    <span class="text-xs ${isOnline ? 'text-green-500' : 'text-gray-400'} ml-2">
                                        ${isOnline ? '● Online' : '○ Offline'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectChatUser(userId) {
            selectedChatUser = users.find(u => u.id === userId);
            if (!selectedChatUser) return;
            
            // Update chat header
            document.getElementById('chatHeader').classList.remove('hidden');
            document.getElementById('chatInput').classList.remove('hidden');
            
            const avatarStyle = selectedChatUser.profilePicture && selectedChatUser.profilePicture.startsWith('data:image') 
                ? `style="background-image: url(${selectedChatUser.profilePicture}); background-size: cover; background-position: center;"` 
                : '';
            const avatarContent = selectedChatUser.profilePicture && selectedChatUser.profilePicture.startsWith('data:image') 
                ? '' 
                : getInitials(selectedChatUser.name);
            
            document.getElementById('chatUserAvatar').setAttribute('style', avatarStyle.replace('style="', '').replace('"', ''));
            document.getElementById('chatUserInitials').textContent = avatarContent;
            document.getElementById('chatUserName').textContent = selectedChatUser.name;
            document.getElementById('chatUserRole').textContent = selectedChatUser.role.charAt(0).toUpperCase() + selectedChatUser.role.slice(1);
            
            // Mark messages as read
            markMessagesAsRead(currentUser.id, userId);
            
            // Render messages
            renderChatMessages();
            
            // Re-render users list to update unread counts
            renderChatUsers();
        }

        function renderChatMessages() {
            if (!selectedChatUser) return;
            
            const chatMessages = document.getElementById('chatMessages');
            const conversation = getConversation(currentUser.id, selectedChatUser.id);
            
            if (conversation.length === 0) {
                chatMessages.innerHTML = `
                    <div class="flex items-center justify-center h-full text-gray-500">
                        <div class="text-center">
                            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"></path>
                            </svg>
                            <p class="text-lg font-medium">Start a conversation</p>
                            <p class="text-sm">Send a message to ${selectedChatUser.name}</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            chatMessages.innerHTML = `
                <div class="space-y-4">
                    ${conversation.map(message => {
                        const isCurrentUser = message.senderId === currentUser.id;
                        const sender = users.find(u => u.id === message.senderId);
                        const timeAgo = getTimeAgo(new Date(message.timestamp));
                        const messageTime = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        return `
                            <div class="flex ${isCurrentUser ? 'justify-end' : 'justify-start'}">
                                <div class="max-w-xs lg:max-w-md">
                                    <div class="${isCurrentUser ? 'bg-blue-600 text-white' : 'bg-white text-gray-800'} rounded-lg px-4 py-2 shadow-sm relative">
                                        <p class="text-sm">${message.content}</p>
                                        <div class="flex items-center justify-between mt-1">
                                            <span class="text-xs ${isCurrentUser ? 'text-blue-100' : 'text-gray-500'}">${messageTime}</span>
                                            ${isCurrentUser ? `
                                                <div class="flex items-center space-x-1">
                                                    ${message.read ? 
                                                        '<svg class="w-3 h-3 text-blue-200" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg><svg class="w-3 h-3 text-blue-200 -ml-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>' :
                                                        '<svg class="w-3 h-3 text-blue-200" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>'
                                                    }
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="flex ${isCurrentUser ? 'justify-end' : 'justify-start'} mt-1">
                                        <span class="text-xs text-gray-500">${sender ? sender.name : 'Unknown'} • ${timeAgo}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                    
                    <!-- Typing indicator (simulated) -->
                    <div id="typingIndicator" class="hidden">
                        <div class="flex justify-start">
                            <div class="max-w-xs lg:max-w-md">
                                <div class="bg-gray-200 rounded-lg px-4 py-2">
                                    <div class="flex space-x-1">
                                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div>
                                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                    </div>
                                </div>
                                <div class="flex justify-start mt-1">
                                    <span class="text-xs text-gray-500">${selectedChatUser.name} is typing...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Simulate typing indicator
        function showTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator && Math.random() > 0.7) { // 30% chance of showing typing
                indicator.classList.remove('hidden');
                setTimeout(() => {
                    indicator.classList.add('hidden');
                }, 2000 + Math.random() * 3000); // Hide after 2-5 seconds
            }
        }

        function sendMessage() {
            if (!selectedChatUser) return;
            
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content) return;
            
            const message = {
                id: Math.max(...messages.map(m => m.id), 0) + 1,
                senderId: currentUser.id,
                receiverId: selectedChatUser.id,
                content: content,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            messages.push(message);
            saveData();
            
            messageInput.value = '';
            renderChatMessages();
            renderChatUsers(); // Update last message display
        }

        function handleMessageKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function getConversation(userId1, userId2) {
            return messages.filter(m => 
                (m.senderId === userId1 && m.receiverId === userId2) ||
                (m.senderId === userId2 && m.receiverId === userId1)
            ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        }

        function getLastMessage(userId1, userId2) {
            const conversation = getConversation(userId1, userId2);
            return conversation.length > 0 ? conversation[conversation.length - 1] : null;
        }

        function getUnreadMessageCount(currentUserId, otherUserId) {
            return messages.filter(m => 
                m.senderId === otherUserId && 
                m.receiverId === currentUserId && 
                !m.read
            ).length;
        }

        function markMessagesAsRead(currentUserId, otherUserId) {
            messages.forEach(message => {
                if (message.senderId === otherUserId && message.receiverId === currentUserId) {
                    message.read = true;
                }
            });
            saveData();
        }

        // Chat search functionality
        document.getElementById('chatSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const userItems = document.querySelectorAll('#chatUsersList > div');
            
            userItems.forEach(item => {
                const userName = item.querySelector('h4').textContent.toLowerCase();
                if (userName.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97446a3f248a7f60',t:'MTc1NjA1NDkyMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
